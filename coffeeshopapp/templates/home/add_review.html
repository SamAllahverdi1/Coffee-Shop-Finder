{% extends 'home/base.html' %}
{% block title %}Review {{ shop.name }}{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="max-width: 800px;">
  <div class="card shadow rounded-3" style="background-color: #B7A684; border: none;">
    <div class="card-body p-5">
      <h3 class="card-title text-center mb-4" style="color: #2B1D14;">Review {{ shop.name }}</h3>
      
      <form method="POST">
        {% csrf_token %}
        
        <!-- Rating Field -->
        <div class="mb-4 text-center">
          <label class="form-label fw-semibold mb-2 d-block" style="color: #2B1D14;">Rating</label>
          <div id="starRating" class="d-flex justify-content-center mb-3 position-relative" style="width: 170px; height: 40px;">
            <!-- Empty Stars -->
            <div class="star-empty position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-between">
              {% for i in "12345" %}
                <i class="bi bi-star star-rating" 
                   data-value="{{ forloop.counter }}" 
                   style="font-size: 2rem; color: #EDE8D0; cursor: pointer;"></i>
              {% endfor %}
            </div>
            <!-- Filled Stars -->
            <div id="starFill" class="star-filled position-absolute top-0 start-0 d-flex justify-content-between overflow-hidden" style="width: 0%;">
              {% for i in "12345" %}
                <i class="bi bi-star-fill" style="font-size: 2rem; color: #FFD700;"></i>
              {% endfor %}
            </div>
          </div>
          <input type="hidden" name="rating" id="ratingValue" value="0">
        </div>
        
        <!-- Review Content Field -->
        <div class="mb-4">
          <label for="id_content" class="form-label fw-semibold" style="color: #2B1D14;">
            Your Review
          </label>
          <textarea name="content" id="id_content" 
                    class="form-control rounded-2 px-3 py-2"
                    style="background-color: #ffffff; color: #2B1D14; 
                           resize: none;
                           overflow: hidden;
                           white-space: pre-wrap;
                           word-wrap: break-word;
                           min-height: 150px;
                           width: 100%;"></textarea>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn px-4 py-2" 
                  style="background-color: #2B1D14; color: #EDE8D0;">
            Submit Review
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Star Rating Script with Pixel-Perfect Fill -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const stars = document.querySelectorAll('.star-rating');
  const ratingInput = document.getElementById('ratingValue');
  const starFill = document.getElementById('starFill');

  let currentRating = 0;
  let lastClicked = null;

  function setFillWidth(rating) {
    const widthPercent = (rating / 5) * 100;
    starFill.style.width = `${widthPercent}%`;
  }

  function renderStarsHover(rating) {
    setFillWidth(rating);
  }

  function renderStarsFinal() {
    setFillWidth(currentRating);
  }

  stars.forEach((star, index) => {
    const starValue = index + 1;

    star.addEventListener('click', function () {
      if (lastClicked === starValue && currentRating === starValue) {
        currentRating = starValue - 0.5;
        lastClicked = null;
      } else {
        currentRating = starValue;
        lastClicked = starValue;
      }

      ratingInput.value = currentRating;
      renderStarsFinal();
    });

    star.addEventListener('mouseenter', function () {
      renderStarsHover(starValue);
    });

    star.addEventListener('mouseleave', function () {
      renderStarsFinal();
    });
  });

  renderStarsFinal();
});
</script>

<style>
  textarea.form-control {
    min-height: 150px;
    background-color: #ffffff !important;
    color: #2B1D14 !important;
    border: 1px solid #2B1D14 !important;
    padding: 10px !important;
  }

  .star-rating {
    transition: all 0.2s ease;
    position: relative;
  }

  .star-filled i {
    pointer-events: none;
  }

  .star-empty i {
    z-index: 2;
  }
</style>
{% endblock %}
